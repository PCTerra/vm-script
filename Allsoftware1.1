# Ensure admin privileges
if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole(`
    [Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Error "Please run this script as Administrator"
    exit 1
}

# Logging
Start-Transcript -Path "C:\install-log.txt" -Append

# Install Chocolatey if missing
if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
    Set-ExecutionPolicy Bypass -Scope Process -Force
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
    Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
}
[Environment]::SetEnvironmentVariable("Path", $env:Path + ";$env:ALLUSERSPROFILE\chocolatey\bin", [EnvironmentVariableTarget]::Machine)

# Helper function
function Install-ChocoPackageIfMissing($name, $checkCmd) {
    if (!(Get-Command $checkCmd -ErrorAction SilentlyContinue)) {
        Write-Host "Installing $name..."
        choco install $name -y --no-progress
    } else {
        Write-Host "$name already installed. Skipping..."
    }
}

# Chocolatey tools
Install-ChocoPackageIfMissing "git" "git"
Install-ChocoPackageIfMissing "jdk17" "java"
Install-ChocoPackageIfMissing "eclipse" "eclipse"
Install-ChocoPackageIfMissing "vscode" "code"
Install-ChocoPackageIfMissing "python" "python"
Install-ChocoPackageIfMissing "nodejs-lts" "node"
Install-ChocoPackageIfMissing "docker-desktop" "docker"
Install-ChocoPackageIfMissing "pgadmin4" "pgadmin4"

# Spring Boot CLI
$SpringDir = "C:\spring"
$SpringBin = "$SpringDir\spring-3.2.5\bin"
if (!(Test-Path "$SpringBin\spring.bat")) {
    Write-Host "Installing Spring Boot CLI..."
    $SpringZipUrl = "https://repo.maven.apache.org/maven2/org/springframework/boot/spring-boot-cli/3.2.5/spring-boot-cli-3.2.5-bin.zip"
    New-Item -ItemType Directory -Force -Path $SpringDir | Out-Null
    Invoke-WebRequest -Uri $SpringZipUrl -OutFile "$SpringDir\spring.zip"
    Expand-Archive -Path "$SpringDir\spring.zip" -DestinationPath $SpringDir
    [Environment]::SetEnvironmentVariable("Path", $env:Path + ";$SpringBin", [EnvironmentVariableTarget]::Machine)
} else {
    Write-Host "Spring Boot CLI already installed"
}

# Apache Kafka
$KafkaDir = "C:\kafka"
$KafkaBin = "$KafkaDir\kafka_2.13-3.7.0\bin\windows"
if (!(Test-Path "$KafkaBin\kafka-topics.bat")) {
    Write-Host "Installing Apache Kafka..."
    $KafkaUrl = "https://downloads.apache.org/kafka/3.7.0/kafka_2.13-3.7.0.tgz"
    New-Item -ItemType Directory -Force -Path $KafkaDir | Out-Null
    Invoke-WebRequest -Uri $KafkaUrl -OutFile "$KafkaDir\kafka.tgz"
    tar -xf "$KafkaDir\kafka.tgz" -C $KafkaDir
    [Environment]::SetEnvironmentVariable("Path", $env:Path + ";$KafkaBin", [EnvironmentVariableTarget]::Machine)
} else {
    Write-Host "Apache Kafka already installed"
}

# Python pip packages
$env:Path += ";C:\Python311\Scripts"
$packages = "pandas","numpy","scikit-learn","matplotlib","seaborn","plotly","jupyterlab","streamlit"
foreach ($pkg in $packages) {
    if (!(pip show $pkg 2>$null)) {
        Write-Host "Installing Python package: $pkg"
        pip install $pkg
    } else {
        Write-Host "Python package $pkg already installed"
    }
}

# DJL Examples
$DJLDir = "C:\djl"
if (!(Test-Path $DJLDir)) {
    Write-Host "Downloading DJL examples..."
    Invoke-WebRequest -Uri "https://github.com/deepjavalibrary/djl/archive/refs/heads/master.zip" -OutFile "$env:TEMP\djl.zip"
    Expand-Archive -Path "$env:TEMP\djl.zip" -DestinationPath $DJLDir
} else {
    Write-Host "DJL already downloaded"
}

# Weka install (safe .exe or .jar fallback)
$WekaDir = "C:\weka"
$WekaExe = "$env:TEMP\weka.exe"
if (!(Test-Path "$WekaDir")) {
    Write-Host "Installing Weka..."
    New-Item -ItemType Directory -Force -Path $WekaDir | Out-Null
    try {
        Invoke-WebRequest -Uri "https://prdownloads.sourceforge.net/weka/weka-3-8-6-azul-zulu-windows.exe" -OutFile $WekaExe
        Start-Process -FilePath $WekaExe -ArgumentList "/S" -Wait
    } catch {
        Write-Warning "Weka installation failed or not supported in non-GUI mode. You can run it manually later."
    }
} else {
    Write-Host "Weka already installed"
}

# Done
Write-Host "`nâœ… All missing components installed successfully." -ForegroundColor Green
Stop-Transcript
exit 0
